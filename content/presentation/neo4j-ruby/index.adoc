= Neo4j and Ruby
:presenter: Brian Underwood
:twitter: cheerfulstoic
:email: brian@brian-underwood.codes
:backend: deckjs
:deckjsdir: ../../../asciidoc/deck.js
:deckjs_theme: neotech
:icons: font
:source-highlighter: codemirror
:navigation:
:goto:
:menu:
:status:
:arrows:
:customjs: ../../../asciidoc/js/checkcypher.js
:gist-source: https://raw.github.com/neo4j-contrib/gists/master/
:footer: Â© All Rights Reserved 2015 | Neo Technology, Inc.
:img: img
:logo: {img}/Neo_Technology.jpg
:allow-uri-read:
:video:
:docs-link: https://github.com/neo4j-contrib/asciidoc-slides[documentation]
:download-link: https://github.com/neo4j-contrib/asciidoc-slides/archive/master.zip[download]
:sectids!:
:deckjs_transition: none

+++
<style type="text/css">
p {
  margin-bottom: 0.3em;
}
.center {
  width: 100%;
  text-align: center;
}
</style>
+++

== Hello my name is

* Brian Underwood
* Developer Advocate at Neo Technology
* Ruby lover, data enthusiast
* @ https://twitter.com/cheerfulstoic[cheerfulstoic] | mailto:brian@brian-underwood.codes[brian@brian-underwood.codes]
* http://www.grandadventures-householdchores.com/[Grand Adventures and Household Chores]


== Neo4j is a Graph Database

+++
<table style="margin: 0 auto; margin-top: -50px;">
  <tr>
    <th>Graph</th>
    <th>Chart</th>
  </tr>
  <tr>
    <td>
      <img src="img/web_console.png" style="height: 410px">
    </td>
    <td>
      <img src="img/pie_chart_vs_bar_chart.jpg" style="height: 410px">
    </td>
  </tr>
</table>
+++

+++ <!-- This is the neo4j web console.  We will see a demo later --> +++

== Why Neo4j?

* Expressive and natural data modeling
* Easy and powerful query language (http://neo4j.com/developer/cypher-query-language/[Cypher])
* Fast and easy querying on complex data relationships
* ACID / Replication

== Neo4j Crash Course

* Nodes and Relationships
* Both are key->value stores
* Nodes can have zero or more labels (User, Post, etc...)
* Relationships have a type (i.e. wrote_post)

== Neo4j Crash Course

* Relationships go from one node to another (directional)
* Querying can be directional or direction agnostic

== Neo4j Crash Course

image::{img}/property_graph_model.png[height="450"]

== Cypher

[source,cypher]
----
MATCH (user:User)<-[rel:written_by]-(post:Post)
  WHERE user.id = 123
  RETURN rel.location, post
----

* Return post and location it was made
* Location stored on the relationship

+++ <!-- ASCII art --> +++

== Cypher

[source,cypher]
----
MATCH (u:User)<-[:written_by]-(:Post)<-[:comments_on]-(c:Comment)-[:written_by]->(u2:User)
  WHERE u.id = 123
  RETURN u2.name, count(c)
----

* Returns users who commented on posts by user #123
* Gives count of the number of comments for each users

+++ <!-- Automatic aggregation on columns when using an aggregate function.  Could also do RETURN p, u2, count(c) to get posts and a count of users for those posts.  Pause for questions --> +++

== Neo4j Resources

 * http://graphdatabases.com O'Reilly's Graph Databases (free and a great intro to the internals of Neo4j)
 * http://neo4j.com/developer/ruby/ Neo4j Ruby guides
 * http://neo4j.com/developer/cypher/ Cypher Introduction

== Why should Rubyists use Neo4j?

* Natural and agile data modeling
* Higher level abstraction
* Web console like ruby console
* Great support

+++ <!-- Of course it makes querying on complex data easy.  Englishy like Ruby --> +++

== What is the Neo4j gem?

* An ActiveModel compliant Ruby wrapper for the Neo4j graph database.

== Neo4j gem features

* OGM (Object Graph Model)
** Properties
** Indexes / Constraints
** Callbacks
** Validations
** Assocations 

== Neo4j gem features

* Modeling nodes and relationships
* Query building / chaining interface similar to https://github.com/rails/arel[arel]
* Transactions
* Migrations (for data)

+++ <!-- Query chaining, but also association chaining! --> +++

== Points of Pride

[role=center]
+++ <h4>Well tested</h4> +++

image::{img}/badges_of_pride.png[]

== Points of Pride

[role=center]
+++ <h4>Well documented</h4> +++

image::{img}/readthedocs_index.png[]

== Points of Pride

[role=center]
+++ <h4>Actively supported</h4> +++

image::{img}/github_pulse.png[]

== Points of Pride

[role=center]
+++ <h4>Actively supported</h4> +++

+++ <h5>Active on StackOverflow</h5> +++

http://stackoverflow.com/questions/ask?tags=neo4j.rb+neo4j+ruby

+++ <h5>Gitter chat room</h5> +++

https://gitter.im/neo4jrb/neo4j

+++ <h5>Twitter</h5> +++

https://twitter.com/neo4jrb

== Points of Pride

[role=center]
+++ <h4>Well loved</h4> +++

image::{img}/stars_and_forks.png[]

== Points of Pride

[role=center]
+++ <h4>Won an award!</h4> +++

image::{img}/graphy.jpg[]

== Models

[source,ruby]
----
class Post
  include Neo4j::ActiveNode

  property :subject
  property :text

  has_one :out, :author, type: :WRITTEN_BY, model_class: :User, rel_class: :WrittenBy
  has_many :out, :tags, type: :TAGGED_AS  # model_class :Tag is assumed
end

class WrittenBy
  include Neo4j::ActiveRel

  from_class :Post
  to_class   :User
  type :WRITTEN_BY # Not needed as default is based on model name

  property :location
end
----

+++ <!-- Include ActiveNode to make a model.  Define properties and assocations like ActiveRecord / Mongoid.  ActiveRel is optional, but great for complex relationships.  Supports validations, callbacks, etc... --> +++

== Usage


[source,ruby]
----

class Post
  has_one :out, :author, type: :WRITTEN_BY, model_class: User
  has_many :in, :comments, type: :COMMENTS_ON
end

class Comment
  has_one :out, :author, type: :WRITTEN_BY, model_class: :User
end

class User
  has_many :in, :posts, origin: :author
end

user.posts.comments(:c).author(:u2).pluck('u2.name, count(c)')

# Compare to:
# MATCH (u:User)<-[:written_by]-(:Post)<-[:comments_on]-(c:Comment)-[:written_by]->(u2:User)
#   WHERE u.id = 123
#   RETURN u2.name, count(c)
----

== A deeper example

[source, ruby]
----
class Post
  has_many :in, :categories, type: :COMMENTS_ON
end

class Comment
  has_one :out, :post, type: :COMMENTS_ON
  has_one :out, :author, type: :WRITTEN_BY, model_class: :User
end

class Category
  property :name, constraint: :unique
end

def post_category_counts(comments)
  comments.post(:post).categories(:category).pluck('category.name', 'count(post)')
end
----

== A deeper example

[source, ruby]
----
class Comment
  def self.post_category_counts
    all.post(:post).categories(:category).pluck('category.name', 'count(post)')
  end
end
----

== A deeper example

[source, bash]
----
> Comment.where(body: /.*mountains.*/i).post_category_counts

 Comment#post#categories 3ms
  MATCH (result_comment:`Comment`)
  WHERE (result_comment.body =~ {result_comment_body})
  MATCH (result_comment)-[rel1:`COMMENTS_ON`]->(post:`Post`)
  MATCH (post)<-[rel2:`COMMENTS_ON`]-(category:`Category`)
  RETURN
    category.name,
    count(post) | {:result_comment_body=>"(?i).*mountains.*"}
----

== A deeper example

[source, bash]
----
> Comment.all.branch { author.where(age: (20..30)) }.post_category_counts

 Comment#post#categories 6ms
  MATCH (n:`Comment`)
  MATCH (n)-[rel1:`WRITTEN_BY`]->(result_author:`User`)
  WHERE (result_author.age IN RANGE({result_author_age_range_min}, {result_author_age_range_max}))
  MATCH (n)-[rel3:`COMMENTS_ON`]->(post:`Post`)
  MATCH (post)<-[rel4:`COMMENTS_ON`]-(category:`Category`)
  RETURN
    category.name,
    count(post) | {:result_author_age_range_min=>20, :result_author_age_range_max=>30}
----

+++ <!-- Here we're going to implement the same Cypher query from before but using the neo4j gem --> +++

== Some supported gems

* devise
* will_paginate
* paperclip
* searchkick
* factory_girl

+++ <!-- Briefly mention neo4apis project here and specifically neo4apis-activerecord --> +++

== Projects built with neo4j gem (libraries)

* https://github.com/neo4jrb/neo4apis[neo4apis]
* https://github.com/neo4jrb/neo4apis-twitter[neo4apis-twitter], https://github.com/neo4jrb/neo4apis-github[neo4apis-github], https://github.com/neo4jrb/neo4apis-activerecord[neo4apis-activerecord]
* https://github.com/neo4j-examples/graph_starter[graph_starter]
* https://github.com/neo4jrb/neolytics[neolytics]

== Projects built with neo4j gem (applications)

* https://github.com/neo4j-examples/ruby_code_analytics[ruby_code_analytics]
* https://github.com/neo4j-examples/graphgist_portal[graphgist_portal]
* https://github.com/neo4j-examples/six_degrees_of_myke[six_degrees_of_myke]

== Projects built with neo4j gem (applications)

* https://github.com/neo4jrb/twitter_analytics[twitter_analytics]
* http://railsrumble.com/entries/378-graphnote[graphnote]

== Neo4j.rb resources

* http://neo4jrb.io/[Neo4j.rb homepage]
* https://github.com/neo4jrb/neo4j[neo4j gem on GitHub]
* http://neo4j.com/developer/ruby-course/[Neo4j Ruby intro course]

== Neo4j.rb resources (videos)

* https://www.youtube.com/playlist?list=PL5klM3mD6alLUhNTPTbj5a3GBjU7oZN0t[Short screencast series]

== Demo time!

Code available on: https://github.com/neo4j-examples/ruby_code_analytics

Example on Heroku: https://ruby-neo4j-code-analysis.herokuapp.com/

++++
<style>
  div#just-this-list div.ulist li { font-size: 1em; }
</style>
<br/>
<div id="just-this-list">
++++

Uses:

* Ruby's http://ruby-doc.org/core-2.0.0/TracePoint.html[TracePoint] library to trace the execution of Ruby code
* The https://github.com/whitequark/parser[parser] gem to parse the AST of files where code was executed

++++
</div id="just-this-list">
++++

== Demo time!

image::{img}/ruby_code_analysis_model.png[height="450"]

== Thank you!  My info again:

Brian Underwood

Developer Advocate at Neo Technology

@ https://twitter.com/cheerfulstoic[cheerfulstoic] | mailto:brian@brian-underwood.codes[brian@brian-underwood.codes]

++++
<br>
++++

My wife's travel blog:

http://www.grandadventures-householdchores.com/[Grand Adventures and Household Chores]

{nbsp} +
{nbsp} +


